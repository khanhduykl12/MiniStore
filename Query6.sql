IF DB_ID('QL_SIEUTHIMINI_TIEMTAPHOA') IS NULL
    CREATE DATABASE QL_SIEUTHIMINI_TIEMTAPHOA;
GO
USE QL_SIEUTHIMINI_TIEMTAPHOA;
GO

/* =======================
   TẠO CÁC BẢNG CHÍNH
   ======================= */
CREATE TABLE VAITRO (
    MAROLE INT NOT NULL,
    MOTA NVARCHAR(50),
    CONSTRAINT PK_VAITRO PRIMARY KEY(MAROLE)
);

CREATE TABLE TAIKHOAN (
    USERNAME VARCHAR(20) NOT NULL,
    PASSWORD VARCHAR(100) NOT NULL,
    MAROLE INT NOT NULL,
    EMAIL VARCHAR(50) UNIQUE NOT NULL,
    CONSTRAINT PK_TAIKHOAN PRIMARY KEY(USERNAME),
    CONSTRAINT FK_TAIKHOAN_VAITRO FOREIGN KEY(MAROLE) REFERENCES VAITRO(MAROLE)
);

CREATE TABLE NHANVIEN (
    HOTEN NVARCHAR(30) NOT NULL,
    NGAYSINH DATE,
    GioiTinh NVARCHAR(3) CHECK (GioiTinh IN ('Nam', N'Nữ')),
    DIACHI NVARCHAR(40),
    SDT VARCHAR(10) CHECK (LEN(SDT) = 10 AND SDT LIKE '[0-9]%'),
    CHUCVU NVARCHAR(10),
    LUONG MONEY CHECK (LUONG >= 0),
    USERNAME VARCHAR(20) UNIQUE,
    CONSTRAINT PK_NHANVIEN PRIMARY KEY(USERNAME),
    CONSTRAINT FK_NHANVIEN_TAIKHOAN FOREIGN KEY(USERNAME) REFERENCES TAIKHOAN(USERNAME)
);

CREATE TABLE NHACUNGCAP (
    MANCC VARCHAR(10) NOT NULL,
    TENNCC NVARCHAR(30),
    DIACHI NVARCHAR(40),
    SDT VARCHAR(10) CHECK (LEN(SDT) = 10 AND SDT LIKE '[0-9]%'),
    EMAIL VARCHAR(30),
    CONSTRAINT PK_NHACUNGCAP PRIMARY KEY(MANCC)
);

CREATE TABLE LOAISANPHAM (
    MALOAI VARCHAR(10) NOT NULL,
    TENLOAI NVARCHAR(20),
	HSD_NGAY INT,
    CONSTRAINT PK_LOAISANPHAM PRIMARY KEY(MALOAI)
);
CREATE TABLE SANPHAM (
    MALOAI VARCHAR(10) NOT NULL,
    MASP VARCHAR(10) NOT NULL,
    TENSP NVARCHAR(100),
	HINH NVARCHAR (255,
    NSX DATE,
    DVT NVARCHAR(10),
    GIABAN MONEY,
    SOLUONG INT,
    MANCC VARCHAR(10) NOT NULL,
    BARCODE VARCHAR(64) NULL,
    GHICHU NVARCHAR(40),
    CONSTRAINT PK_MASP PRIMARY KEY(MASP),
    CONSTRAINT FK_MASP_LOAISANPHAM FOREIGN KEY(MALOAI) REFERENCES LOAISANPHAM(MALOAI),
    CONSTRAINT FK_MAS_NHACUNGCAP FOREIGN KEY(MANCC) REFERENCES NHACUNGCAP(MANCC)
);

CREATE TABLE KHACHHANG (
    MAKH VARCHAR(10) NOT NULL,
    LOAIKH VARCHAR(6) NOT NULL CHECK (LOAIKH IN (N'Le', N'DaiLy')),
    HOTEN NVARCHAR(20),
    NGAYSINH DATE,
    SDT VARCHAR(10) CHECK (LEN(SDT) = 10 AND SDT LIKE '[0-9]%'),
    GioiTinh NVARCHAR(3) CHECK (GioiTinh IN ('Nam', N'Nữ')),
    DIACHI NVARCHAR(30),
    DIEMTICHLUY INT,
    USERNAME VARCHAR(20) UNIQUE FOREIGN KEY REFERENCES TAIKHOAN(USERNAME),
    CONSTRAINT PK_KHACHHANG PRIMARY KEY(MAKH)
);

CREATE TABLE HDNHAP (
    MAHDNHAP VARCHAR(10) NOT NULL,
    NGAYLAP DATETIME NOT NULL,
    USERNAME VARCHAR(20),
    MANCC VARCHAR(10) NOT NULL,
    GHICHU NVARCHAR(225),
    CONSTRAINT PK_HDNHAP PRIMARY KEY(MAHDNHAP),
    CONSTRAINT FK_HDNHAP_NHACC FOREIGN KEY(MANCC) REFERENCES NHACUNGCAP(MANCC),
    CONSTRAINT FK_HDNHAP_NHANVIEN FOREIGN KEY(USERNAME) REFERENCES NHANVIEN(USERNAME)
);

CREATE TABLE CHITIETHDNHAP (
    MAHDNHAP VARCHAR(10) NOT NULL,
    MASP VARCHAR(10) NOT NULL,
    SOLUONGTN INT NOT NULL CHECK (SOLUONGTN >= 0),
    DONGIANHAP INT NOT NULL,
    THANHTIENN AS (SOLUONGTN * DONGIANHAP) PERSISTED,
    GHICHU NVARCHAR(225),

    CONSTRAINT PK_CHITIETHDNHAP PRIMARY KEY(MAHDNHAP, MASP),
    CONSTRAINT FK_CHITIETHDNHAP_SANPHAM FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP),
    CONSTRAINT FK_CHITIETHDNHAP_HDNHAP FOREIGN KEY(MAHDNHAP) REFERENCES HDNHAP(MAHDNHAP)
);

CREATE TABLE HDBAN (
    MAHD VARCHAR(10) NOT NULL,
    NGAYLAP DATE NOT NULL,
    USERNAME VARCHAR(20),
    GHICHU NVARCHAR(225),
    MAKH VARCHAR(10),
    CONSTRAINT PK_HDBAN PRIMARY KEY(MAHD),
    CONSTRAINT FK_HDBAN_NHANVIEN FOREIGN KEY(USERNAME) REFERENCES NHANVIEN(USERNAME),
    CONSTRAINT FK_HDBAN_KHACHHANG FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)
);

CREATE TABLE CHITIETHDBAN (
    MAHD VARCHAR(10) NOT NULL,
    MASP VARCHAR(10) NOT NULL,
    SOLUONG INT,
    DONGIA MONEY CHECK (DONGIA >= 0),
    THANHTIEN AS (SOLUONG * DONGIA) PERSISTED,
    CONSTRAINT PK_CHITIETHDBAN PRIMARY KEY(MAHD, MASP),
    CONSTRAINT FK_CHITIETHDBAN FOREIGN KEY(MAHD) REFERENCES HDBAN(MAHD),
    CONSTRAINT FK_CHITIETHDBAN_SANPHAM FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)
);


CREATE TABLE CONGNO (
    MACONGNO VARCHAR(20) NOT NULL,
    MAHD_NHAP VARCHAR(10) NOT NULL,
    MANCC VARCHAR(10) NOT NULL,
    NGAYPHATSINH DATE NOT NULL DEFAULT GETDATE(),
    SOTIENPHAITRA MONEY NOT NULL,
    DATHANHTOAN MONEY NOT NULL DEFAULT 0 CHECK (DATHANHTOAN >= 0),
    CONLAI AS (SOTIENPHAITRA - DATHANHTOAN) PERSISTED,
    HANTRA DATE NULL,
    TRANGTHAI NVARCHAR(50) DEFAULT N'Chưa thanh toán',
    GHICHU NVARCHAR(500),
    CONSTRAINT PK_CONGNO PRIMARY KEY(MACONGNO),
    CONSTRAINT FK_CONGNO_NHACUNGCAP FOREIGN KEY(MANCC) REFERENCES NHACUNGCAP(MANCC),
    CONSTRAINT FK_CONGNO_HDNHAP FOREIGN KEY(MAHD_NHAP) REFERENCES HDNHAP(MAHDNHAP)
);

CREATE TABLE PHIEUTHANHTOAN (
    MAPTT VARCHAR(10),
    MACONGNO VARCHAR(20) NOT NULL,
    SOTIENTRA MONEY NOT NULL,
    NGAYTRA DATE NOT NULL DEFAULT GETDATE(),
    GHICHU NVARCHAR(100),
    CONSTRAINT PK_PHIEUTHANHTOAN PRIMARY KEY(MAPTT),
    CONSTRAINT FK_PHIEUTHANHTOAN_CONGNO FOREIGN KEY(MACONGNO) REFERENCES CONGNO(MACONGNO)
);


   ---- TRIGGERS ----

-- Nhập hàng
CREATE TRIGGER trg_UpdateSoLuongNhap
ON CHITIETHDNHAP
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE SP
    SET SP.SOLUONG = SP.SOLUONG + I.SOLUONGTN
    FROM SANPHAM SP
    JOIN INSERTED I ON SP.MASP = I.MASP;
END;

-- Bán hàng
CREATE TRIGGER trg_UpdateSoLuongBan
ON CHITIETHDBAN
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE SP
    SET SP.SOLUONG = SP.SOLUONG - I.SOLUONG
    FROM SANPHAM SP
    JOIN INSERTED I ON SP.MASP = I.MASP;
END;

--- TRIGGER CÔNG NỢ---

CREATE TRIGGER trg_UpdateCongNo_AfterPTT
ON PHIEUTHANHTOAN
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH upd AS (
        SELECT i.MACONGNO, SUM(i.SOTIENTRA) AS DaTraMoi
        FROM INSERTED i
        GROUP BY i.MACONGNO
    )
    UPDATE cn
    SET cn.DATHANHTOAN = cn.DATHANHTOAN + u.DaTraMoi,
        cn.TRANGTHAI = CASE 
            WHEN (cn.SOTIENPHAITRA - (cn.DATHANHTOAN + u.DaTraMoi)) <= 0 THEN N'Đã thanh toán'
            WHEN (cn.DATHANHTOAN + u.DaTraMoi) > 0 THEN N'Thanh toán một phần'
            ELSE N'Chưa thanh toán' END
    FROM CONGNO cn
    JOIN upd u ON u.MACONGNO = cn.MACONGNO;
END


/* =======================
   VIEW
   ======================= */
-- Tồn kho
CREATE VIEW V_TONKHO AS 
SELECT 
    sp.MASP, sp.MALOAI, sp.TENSP, sp.NSX,
    CASE 
        WHEN sp.NSX IS NOT NULL AND l.HSD_NGAY IS NOT NULL
            THEN DATEADD(DAY, l.HSD_NGAY, sp.NSX)
        ELSE NULL
    END AS HSD,
    sp.DVT, sp.GIABAN, sp.MANCC,
    ISNULL(NHAP.SOLUONGNHAP, 0) AS SOLUONGNHAP,
    ISNULL(BAN.SOLUONGBAN, 0)   AS SOLUONGBAN,
    ISNULL(NHAP.SOLUONGNHAP, 0) - ISNULL(BAN.SOLUONGBAN, 0) AS SOLUONGTON
FROM SANPHAM sp
JOIN LOAISANPHAM l ON l.MALOAI = sp.MALOAI
LEFT JOIN (
    SELECT MASP, SUM(SOLUONGTN) AS SOLUONGNHAP 
    FROM CHITIETHDNHAP 
    GROUP BY MASP
) NHAP ON sp.MASP = NHAP.MASP
LEFT JOIN (
    SELECT MASP, SUM(SOLUONG) AS SOLUONGBAN 
    FROM CHITIETHDBAN 
    GROUP BY MASP
) BAN ON sp.MASP = BAN.MASP;
GO

-- Công nợ phải trả
CREATE VIEW V_CONGNO_PHAITRA AS
SELECT cn.MACONGNO, cn.MAHD_NHAP AS MAHD, cn.MANCC, ncc.TENNCC AS TENNHACUNGCAP,
       cn.NGAYPHATSINH, cn.SOTIENPHAITRA, cn.DATHANHTOAN, cn.CONLAI,
       cn.HANTRA, cn.TRANGTHAI, cn.GHICHU
FROM CONGNO cn
JOIN NHACUNGCAP ncc ON ncc.MANCC = cn.MANCC;

-- Nhân viên + tài khoản
CREATE VIEW V_NHANVIEN_TAIKHOAN AS
SELECT NV.USERNAME, NV.HOTEN, NV.GioiTinh, NV.NGAYSINH, NV.DIACHI,
       NV.CHUCVU, NV.SDT, TK.EMAIL
FROM NHANVIEN NV
JOIN TAIKHOAN TK ON NV.USERNAME = TK.USERNAME;

----Sản phẩm + Nhà Cung Cấp---
CREATE VIEW V_SANPHAM_NHACUNGCAP AS
SELECT SP.MASP,SP.TENSP,SP.SOLUONG,NCC.TENNCC
FROM SANPHAM SP
JOIN NHACUNGCAP NCC ON SP.MANCC = NCC.MANCC;

----Hạn Sử Dụng Sản phẩm---
CREATE OR ALTER VIEW V_SANPHAM_HSD
AS
WITH H AS (
    SELECT
        sp.MASP,
        sp.TENSP,
        sp.MALOAI,
        l.TENLOAI,
        sp.NSX,
        l.HSD_NGAY,
        CASE 
            WHEN sp.NSX IS NOT NULL AND l.HSD_NGAY IS NOT NULL
                THEN DATEADD(DAY, l.HSD_NGAY, sp.NSX)
            ELSE NULL
        END AS HSD
    FROM SANPHAM sp
    JOIN LOAISANPHAM l ON l.MALOAI = sp.MALOAI
)
SELECT
    MASP, TENSP, MALOAI, TENLOAI, NSX, HSD_NGAY, HSD,
    DATEDIFF(DAY, CAST(GETDATE() AS DATE), HSD) AS NgayConLai,
    CASE
        WHEN HSD IS NULL THEN N'Chưa đủ dữ liệu'
        WHEN HSD <  CAST(GETDATE() AS DATE) THEN N'Đã hết hạn'
        WHEN HSD <= DATEADD(DAY, 7, CAST(GETDATE() AS DATE)) THEN N'Sắp hết hạn (≤7 ngày)'
        ELSE N'Còn hạn'
    END AS TinhTrang
FROM H;
GO


-- Thống kê doanh thu
CREATE VIEW VIEW_ThongKeDoanhThu AS
SELECT CAST(h.NGAYLAP AS DATE) AS Ngay,
       ISNULL(SUM(ct.SOLUONG * ct.DONGIA), 0) AS DoanhThu,
       ISNULL((SELECT SUM(ctn.SOLUONGTN * ctn.DONGIANHAP)
               FROM HDNHAP n JOIN CHITIETHDNHAP ctn ON n.MAHDNHAP = ctn.MAHDNHAP
               WHERE CAST(n.NGAYLAP AS DATE) = CAST(h.NGAYLAP AS DATE)), 0) AS ChiPhi,
       ISNULL(SUM(ct.SOLUONG * ct.DONGIA), 0)
       - ISNULL((SELECT SUM(ctn.SOLUONGTN * ctn.DONGIANHAP)
                 FROM HDNHAP n JOIN CHITIETHDNHAP ctn ON n.MAHDNHAP = ctn.MAHDNHAP
                 WHERE CAST(n.NGAYLAP AS DATE) = CAST(h.NGAYLAP AS DATE)), 0) AS LoiNhuan
FROM HDBAN h
LEFT JOIN CHITIETHDBAN ct ON h.MAHD = ct.MAHD
GROUP BY CAST(h.NGAYLAP AS DATE);



--Insert du lieu---
-- Vai trò
INSERT INTO VAITRO (MAROLE, MOTA) VALUES
(1, N'Quản lý'),
(2, N'Nhân viên'),
(3, N'Khách hàng');

-- Tài khoản + Nhân viên
INSERT INTO TAIKHOAN (USERNAME, PASSWORD, MAROLE, EMAIL) VALUES
('admin01', '123456', 1, 'admin01@gmail.com'),
('nv01',    '123456', 2, 'nv01@gmail.com');

INSERT INTO NHANVIEN (HOTEN, NGAYSINH, GioiTinh, DIACHI, SDT, CHUCVU, LUONG, USERNAME) VALUES
(N'Nguyễn Văn A', '1995-05-20', N'Nam', N'123 Lê Lợi, Q1', '0901234567', N'Quản lý', 15000000, 'admin01'),
(N'Trần Thị B',   '2000-10-10', N'Nữ', N'45 Hai Bà Trưng', '0912345678', N'Nhân viên', 8000000, 'nv01');
(N'Phạm Minh K', '1992-03-22', N'Nam', N'12 Quang Trung, Gò Vấp', '0901112233', N'Quản lý', 16000000, 'admin02'),
(N'Lê Thị L',    '1999-07-05', N'Nữ',  N'89 Nguyễn Văn Lượng',    '0902223344', N'Nhân viên', 8500000, 'nv02'),
(N'Đỗ Hoàng M',  '1997-11-18', N'Nam', N'45 Phan Huy Ích',        '0903334455', N'Nhân viên', 8200000, 'nv03');

-- Nhà cung cấp
INSERT INTO NHACUNGCAP (MANCC, TENNCC, DIACHI, SDT, EMAIL) VALUES
('NCC01', N'Vinamilk', N'123 Nguyễn Trãi, Q5', '0900000001', 'contact@vinamilk.vn'),
('NCC02', N'Acecook',  N'456 Lê Văn Sỹ, Q3',   '0900000002', 'info@acecook.vn');
('NCC03', N'PepsiCo VN', N'12 Phạm Văn Đồng, TP.Thủ Đức', '0900000003', 'cs@pepsico.vn'),
('NCC04', N'Orion', N'KCN Tân Tạo, Q.Bình Tân', '0900000004', 'contact@orion.vn'),
('NCC05', N'Unilever VN', N'KCN Tây Bắc Củ Chi', '0900000005', 'support@unilever.com'),
('NCC06', N'Nông Sản Xanh', N'Kho Trường Chinh, Tân Bình', '0900000006', 'sales@nongsanxanh.vn');


-- Loại sản phẩm
INSERT INTO LOAISANPHAM (MALOAI, TENLOAI, HSD_NGAY) VALUES
('L01', N'Sữa',730),
('L02', N'Mì gói',730),
('L03', N'Nước giải khát',730);
('L04', N'Bánh kẹo', 270),
('L05', N'Gia dụng', NULL),      
('L06', N'Đồ đông lạnh', 180),
('L07', N'Thực phẩm tươi', 7);

-- Sản phẩm
INSERT INTO SANPHAM (MALOAI, MASP, TENSP, HINH, NSX, DVT, GIABAN, SOLUONG, MANCC, BARCODE, GHICHU) VALUES
('L01', 'SP001', N'Sữa tươi 1L', N'Sua1L.png', '2025-03-10', N'Hộp', 28000, 100, 'NCC01', '8931234567890', N'HSD 6 tháng'),
('L01', 'SP002', N'Sữa chua uống 180ml', N'SuaChuaUong.png', '2025-04-05', N'Lốc', 6000, 200, 'NCC01', '8931234567891', N'HSD 3 tháng'),
('L02', 'SP003', N'Mì Hảo Hảo tôm chua cay', N'HaoHao.png', '2025-02-20', N'Thùng', 105000, 50, 'NCC02', '8931234567892', N'Thùng 30 gói'),
('L03', 'SP004', N'Pepsi lon 330ml', N'Pepsi.png', '2025-09-15', N'Lon', 10000, 80, 'NCC03', '8931234567893', N'HSD 6 tháng'),
('L03', 'SP005', N'7Up lon 330ml', N'7Up.png', '2025-09-16', N'Lon', 10000, 70, 'NCC03', '8931234567894', N'HSD 6 tháng'),
('L04', 'SP006', N'Chocopie hộp 12 cái', N'Chocopie.png', '2025-08-20', N'Hộp', 52000, 60, 'NCC04', '8931234567895', N'HSD 12 tháng'),
('L04', 'SP007', N'Snack khoai tây 90g', N'SnackKhoai.png', '2025-09-05', N'Gói', 18000, 90, 'NCC04', '8931234567896', N'HSD 9 tháng'),
('L05', 'SP008', N'Nước rửa chén Sunlight 750ml', N'Sunlight.png', '2025-06-01', N'Chai', 38000, 120, 'NCC05', '8931234567897', N'HSD 24 tháng'),
('L05', 'SP009', N'Bột giặt OMO 3kg', N'Omo.png', '2025-05-10', N'Túi', 195000, 110, 'NCC05', '8931234567898', N'HSD 24 tháng'),
('L06', 'SP010', N'Xúc xích đông lạnh 500g', N'XucXich.png', '2025-09-28', N'Gói', 65000, 80, 'NCC05', '8931234567899', N'HSD 12 tháng'),
('L07', 'SP011', N'Rau xà lách 300g', N'XaLach.png', '2025-10-03', N'Bó', 12000, 100, 'NCC06', '8931234567900', N'HSD 7 ngày'),
('L07', 'SP012', N'Thịt heo xay 500g', N'ThitHeoXay.png', '2025-10-04', N'Khay', 85000, 90, 'NCC06', '8931234567901', N'HSD 5 ngày'),
('L01', 'SP013', N'Sữa tươi 180ml (lốc 4)', N'Sua180.png', '2025-09-10', N'Lốc', 26000, 60, 'NCC01', '8931234567902', N'HSD 6 tháng'),
('L02', 'SP014', N'Mì Đệ Nhất bò hầm', N'DeNhat.png', '2025-07-30', N'Gói', 12000, 70, 'NCC02', '8931234567903', N'HSD 9 tháng'),
('L03', 'SP015', N'Aquafina 500ml', N'Aquafina.png', '2025-09-20', N'Chai', 7000, 200, 'NCC03', '8931234567904', N'HSD 24 tháng');

-- Khách hàng
INSERT INTO TAIKHOAN (USERNAME, PASSWORD, MAROLE, EMAIL) VALUES
('kh01', '123456', 3, 'kh01@gmail.com');
('admin02', '123456', 1, 'admin02@gmail.com'),
('nv02',    '123456', 2, 'nv02@gmail.com'),
('nv03',    '123456', 2, 'nv03@gmail.com'),
('kh02',    '123456', 3, 'kh02@gmail.com'),
('kh03',    '123456', 3, 'kh03@gmail.com'),
('kh04',    '123456', 3, 'kh04@gmail.com');

INSERT INTO KHACHHANG (MAKH, LOAIKH, HOTEN, NGAYSINH, SDT, GioiTinh, DIACHI, DIEMTICHLUY, USERNAME) VALUES
('KH01', N'Le', N'Lê Văn C', '2002-03-15', '0934567890', N'Nam', N'789 Trường Chinh', 120, 'kh01');
('KH02', N'Le',     N'Ngô Mỹ N',   '1998-04-12', '0981112233', N'Nữ',  N'12 CMT8, Q3', 60,  'kh02'),
('KH03', N'DaiLy',  N'Đại lý P&T', '1990-12-01', '0982223344', N'Nam', N'45 Nguyễn Kiệm', 350, 'kh03'),
('KH04', N'Le',     N'Trần Văn O', '2001-01-20', '0983334455', N'Nam', N'88 Phan Đăng Lưu', 15, 'kh04');


-- Hóa đơn nhập (Vinamilk)
INSERT INTO HDNHAP (MAHDNHAP, NGAYLAP, USERNAME, MANCC, GHICHU) VALUES
('HDN001', '2025-09-22', 'admin01', 'NCC01', N'Nhập hàng Vinamilk'),
('HDN002', '2025-09-23', 'admin01', 'NCC02', N'Nhập Thêm mì');
('HDN003', '2025-09-25T10:15:00', 'admin01', 'NCC03', N'Nhập nước ngọt'),
('HDN004', '2025-10-01T09:05:00', 'admin02', 'NCC04', N'Nhập bánh kẹo'),
('HDN005', '2025-10-03T14:20:00', 'admin02', 'NCC05', N'Nhập gia dụng'),
('HDN006', '2025-10-05T08:40:00', 'admin01', 'NCC06', N'Nhập thực phẩm tươi');

INSERT INTO CHITIETHDNHAP (MAHDNHAP, MASP, SOLUONGTN, DONGIANHAP, GHICHU) VALUES
('HDN001', 'SP001', 50, 20000, N'Nhập sữa tươi'),
('HDN001', 'SP002', 100, 4000, N'Nhập sữa chua'),

('HDN002', 'SP003', 20, 90000, N'Nhập mì');

('HDN003', 'SP004', 150, 6500,  N'Pepsi'),
('HDN003', 'SP005', 120, 6500,  N'7Up'),
('HDN003', 'SP015', 200, 4500,  N'Nước suối'),

('HDN004', 'SP006',  60, 32000, N'Chocopie'),
('HDN004', 'SP007',  80, 12000, N'Snack'),

('HDN005', 'SP008', 100, 20000, N'Sunlight'),
('HDN005', 'SP009',  40,120000, N'OMO'),

('HDN006', 'SP011',  60,  6000, N'Rau xà lách'),
('HDN006', 'SP012',  50, 85000, N'Thịt heo xay');

-- Hóa đơn bán (cho khách KH01)
INSERT INTO HDBAN (MAHD, NGAYLAP, USERNAME, GHICHU, MAKH) VALUES
('HDB001', '2025-09-23', 'nv01', N'Bán cho khách KH01', 'KH01');
('HDB002', '2025-10-01', 'nv01', N'Bán lẻ', 'KH01'),
('HDB003', '2025-10-02', 'nv02', N'Bán lẻ', 'KH02'),
('HDB004', '2025-10-03', 'nv03', N'Bán lẻ', 'KH03'),
('HDB005', '2025-10-04', 'nv02', N'Bán lẻ', 'KH02'),
('HDB006', '2025-10-05', 'nv03', N'Bán lẻ', 'KH04');

INSERT INTO CHITIETHDBAN (MAHD, MASP, SOLUONG, DONGIA) VALUES
('HDB001', 'SP001', 2, 28000),
('HDB001', 'SP003', 1, 105000);

('HDB002', 'SP004',  5, 10000),
('HDB002', 'SP006',  1, 52000),

('HDB003', 'SP002',  6,  6000),
('HDB003', 'SP014', 10, 12000),

('HDB004', 'SP005',  8, 10000),
('HDB004', 'SP015', 12,  7000),

('HDB005', 'SP008',  2, 38000),
('HDB005', 'SP009',  1,195000),

('HDB006', 'SP011',  5, 12000),
('HDB006', 'SP012',  3, 85000);

INSERT INTO CONGNO (MACONGNO, MAHD_NHAP, MANCC, NGAYPHATSINH, SOTIENPHAITRA, DATHANHTOAN, HANTRA, TRANGTHAI, GHICHU)
VALUES 
('CN001', 'HDN001', 'NCC01', '2025-09-23', 2000000, 0, '2025-10-07', N'Chưa thanh toán', N'Công nợ phát sinh từ nhập hàng Vinamilk');
('CN002', 'HDN003', 'NCC03', '2025-09-25', 2655000, 0, '2025-10-10', N'Chưa thanh toán', N'Pepsi/7Up/Aquafina'),
('CN003', 'HDN004', 'NCC04', '2025-10-01', 2880000, 0, '2025-10-12', N'Chưa thanh toán', N'Bánh kẹo'),
('CN004', 'HDN005', 'NCC05', '2025-10-03', 6800000, 0, '2025-10-20', N'Chưa thanh toán', N'Gia dụng');


INSERT INTO PHIEUTHANHTOAN (MAPTT, MACONGNO, SOTIENTRA, NGAYTRA, GHICHU)
VALUES 
('PTT001', 'CN001', 500000, '2025-09-25', N'Thanh toán đợt 1 cho Vinamilk');
('PTT002', 'CN002',  800000, '2025-10-02', N'Thanh toán CN002 đợt 1'),
('PTT003', 'CN004', 2000000, '2025-10-06', N'Thanh toán CN004 đợt 1');

-----Stored Procedure---
/*Tìm sản phẩm theo khoảng giá*/
CREATE PROCEDURE usp_TimSanPhamTheoGia
    @GiaMin MONEY,
    @GiaMax MONEY
AS
BEGIN
IF @GiaMin > @GiaMax
BEGIN
RAISERROR (N'Gia Min khong duoc lon hon Gia Max',16,1);
RETURN;
END
    SET NOCOUNT ON;

    SELECT MASP, TENSP, GIABAN, SOLUONG
    FROM SANPHAM
    WHERE GIABAN BETWEEN @GiaMin AND @GiaMax
    ORDER BY GIABAN ASC;
END
EXEC usp_TimSanPhamTheoGia @GiaMin = 5000, @GiaMax = 30000;

/* Tính doanh thu theo ngày hoặc khoảng thời gian */
CREATE PROCEDURE usp_ThongKeDoanhThu
    @TuNgay DATE,
    @DenNgay DATE
AS
BEGIN
    SET NOCOUNT ON;
    SELECT 
        CAST(h.NGAYLAP AS DATE) AS Ngay,
        SUM(ct.SOLUONG * ct.DONGIA) AS DoanhThu,
        (
            ISNULL(SUM(ct.SOLUONG * ct.DONGIA), 0)
            - ISNULL(SUM(ctn.SOLUONGTN * ctn.DONGIANHAP), 0)
        ) AS LoiNhuan
    FROM HDBAN h
    JOIN CHITIETHDBAN ct ON h.MAHD = ct.MAHD
    LEFT JOIN HDNHAP n ON CAST(h.NGAYLAP AS DATE) = CAST(n.NGAYLAP AS DATE)
    LEFT JOIN CHITIETHDNHAP ctn ON n.MAHDNHAP = ctn.MAHDNHAP
    WHERE h.NGAYLAP BETWEEN @TuNgay AND @DenNgay
    GROUP BY CAST(h.NGAYLAP AS DATE);
END

EXEC usp_ThongKeDoanhThu @TuNgay = '2025-09-01', @DenNgay = '2025-10-10';


-----User-defined Function----
/*Lấy tuổi nhân viên từ ngày sinh*/
CREATE FUNCTION dbo.ufn_TinhTuoi(@NgaySinh DATE)
RETURNS INT
AS
BEGIN
    DECLARE @Tuoi INT;
    SET @Tuoi = DATEDIFF(YEAR, @NgaySinh, GETDATE());
    -- Nếu chưa tới sinh nhật năm nay thì trừ 1
    IF (MONTH(@NgaySinh) > MONTH(GETDATE()))
       OR (MONTH(@NgaySinh) = MONTH(GETDATE()) AND DAY(@NgaySinh) > DAY(GETDATE()))
        SET @Tuoi = @Tuoi - 1;
    RETURN @Tuoi;
END
SELECT HOTEN, dbo.ufn_TinhTuoi(NGAYSINH) AS TUOI FROM NHANVIEN;

----Cursor----
/*Liệt kê sản phẩm sắp hết hạn (HSD < 30 ngày)*/
CREATE OR ALTER PROCEDURE usp_SanPhamSapHetHan
    @NgayHetHan INT 
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH SP_HSD AS (
        SELECT
            sp.MASP,sp.TENSP,sp.MALOAI,l.TENLOAI,sp.NSX,l.HSD_NGAY,
            HSD = DATEADD(DAY, l.HSD_NGAY, sp.NSX)
        FROM SANPHAM sp
        JOIN LOAISANPHAM l ON l.MALOAI = sp.MALOAI
        WHERE sp.NSX IS NOT NULL
          AND l.HSD_NGAY IS NOT NULL
    )
    SELECT
        MASP,TENSP,MALOAI,TENLOAI,NSX,HSD_NGAY,HSD,
        NgayConLai = DATEDIFF(DAY, CAST(GETDATE() AS DATE), HSD)
    FROM SP_HSD
    WHERE HSD <= DATEADD(DAY, @NgayHetHan, CAST(GETDATE() AS DATE))
    ORDER BY HSD ASC;  -- món nào sắp/đã hết hạn lên trước
END
GO

EXEC usp_SanPhamSapHetHan @NgayHetHan = 90;



select * from V_TONKHO;
select * from V_NHANVIEN_TAIKHOAN;
select * from VIEW_ThongKeDoanhThu;
select * from V_CONGNO_PHAITRA;
select * from V_SANPHAM_NHACUNGCAP;
select * from V_SANPHAM_HSD

select * from VAITRO
select * from TAIKHOAN 
select * from NHANVIEN
select * from NHACUNGCAP
select * from LOAISANPHAM
select * from SANPHAM
select * from KHACHHANG
select * from HDNHAP
select * from CHITIETHDNHAP
select * from HDBAN
select * from CHITIETHDBAN
select * from CONGNO
select * from PHIEUTHANHTOAN